package com.spacebottle.controllers;import java.util.Date;import java.util.List;import java.util.Timer;import java.util.TimerTask;import android.app.AlertDialog;import android.app.Dialog;import android.content.Context;import android.content.DialogInterface;import android.content.Intent;import android.content.SharedPreferences;import android.location.Criteria;import android.location.LocationManager;import android.os.AsyncTask;import android.os.Bundle;import android.os.Handler;import android.os.Looper;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.Window;import android.widget.Button;import android.widget.EditText;import android.widget.ProgressBar;import android.widget.TextView;import android.widget.Toast;import com.example.spacebottle.R;import com.google.android.gms.gcm.GoogleCloudMessaging;import com.microsoft.windowsazure.messaging.NotificationHub;import com.microsoft.windowsazure.mobileservices.ServiceFilterResponse;import com.microsoft.windowsazure.mobileservices.TableOperationCallback;import com.microsoft.windowsazure.mobileservices.TableQueryCallback;import com.microsoft.windowsazure.notifications.NotificationsManager;import com.spacebottle.helper.SBAuthenticateCallback;import com.spacebottle.models.Device;import com.spacebottle.models.Devices;import com.spacebottle.models.Message;import com.spacebottle.models.Messages;import com.spacebottle.models.Position;import com.spacebottle.models.Positions;import com.spacebottle.models.Tickets;public class PostActivity extends SBActivity {	private Tickets mTickets;	private Date limit;	private Timer timer = null;	private Handler handle = new Handler();	private double latitude;	private double longitude;	private Position mPosition;	private SharedPreferences pref;	private String message;	private Bundle bundle;	private Devices mDevices;	private Positions mPositions;	private LocationManager mLocationManager;	private Criteria mCriteria;	private GoogleCloudMessaging gcm;	private NotificationHub hub;	private TextView messageTextView;	private Button postButton;	private TextView limitClock;	public PostActivity() {		// TODO Auto-generated constructor stub	}	@Override	public void onCreate(Bundle savedInstanceState) {		super.onCreate(savedInstanceState);		requestWindowFeature(Window.FEATURE_NO_TITLE);		setContentView(R.layout.activity_post);		messageTextView =  (TextView)findViewById(R.id.message_text_view);		self = this;		setProgressBar((ProgressBar) findViewById(R.id.loadingProgressBar));		hideProgressBar();		NotificationsManager.handleNotifications(this, getString(R.string.sender_id), PushHandler.class);		Intent intent = getIntent();		mPosition = (Position)intent.getSerializableExtra("position");		bundle = intent.getBundleExtra("bundle");		message = (String)bundle.getString("message");		if(message != null){			messageTextView.setText("メッセージはありません");		} else {			messageTextView.setText(message);		}		connect(new SBAuthenticateCallback(){			@Override			public void success() {				hideProgressBar();				initialize();			}			@Override			public void error(Exception exception) {				// TODO Auto-generated method stub			}});	}	private void initializeLimitClock() {		if (timer == null) {			limitClock.setText("10:00");			timer = new Timer();			timer.schedule(new MyTimer(), 1000); // ミリ秒でセット		}	}	class MyTimer extends TimerTask {		@Override		public void run() {			handle.post(new Runnable() {				@Override				public void run() {					Date now = new Date();					if (limit.compareTo(now) >= 0) {						long leftMillisecond = limit.getTime() - now.getTime();						int leftSecond = (int) (leftMillisecond / 1000);						int leftMinutes = leftSecond / 60;						leftSecond = leftSecond - 60 * leftMinutes;						limitClock.setText(leftMinutes + ":" + leftSecond);					} else {						Log.v("MyTimer", "チケットの有効期限切れ");					}				}			});		}	}	@Override	protected Dialog onCreateDialog(int id) {	        //レイアウトの呼び出し	        LayoutInflater factory = LayoutInflater.from(this);	        final View inputView = factory.inflate(R.layout.edit_dialog, null);	        //ダイアログの作成(AlertDialog.Builder)	        return new AlertDialog.Builder(PostActivity.this)	            .setIcon(android.R.drawable.ic_dialog_alert)	            .setTitle("タイトル")	            .setView(inputView)	            .setPositiveButton("OK", new DialogInterface.OnClickListener() {	                public void onClick(DialogInterface dialog, int whichButton) {	                	EditText edit = (EditText)inputView.findViewById(R.id.dialog_edittext);	                	sendMessage(edit.getText().toString());	                }	            })	            .setNegativeButton("Cancel", new DialogInterface.OnClickListener() {	                public void onClick(DialogInterface dialog, int whichButton) {	                    /* キャンセル処理 */	                }	            })	            .create();	}	@SuppressWarnings("unchecked")	private void registerWithNotificationHubs() {	   new AsyncTask() {	      @Override	      protected Object doInBackground(Object... params) {	         try {	            String regid = gcm.register("879711313152");	            //hub.register(regid);	            mDevices = new Devices(mClient);	    		mDevices.add(new Device(hub.register(regid).getRegistrationId()));	         } catch (Exception e) {	            return e;	         }	         return null;	     }	   }.execute(null, null, null);	}	private void initialize(){		messageTextView = (TextView) findViewById(R.id.message_text_view);		postButton = (Button) findViewById(R.id.post_button);		limitClock = (TextView) findViewById(R.id.limit_clock);		postButton.setOnClickListener(new View.OnClickListener() {			@Override			public void onClick(View v) {				// TODO Auto-generated method stub				showDialog(0);			}		});		mTickets = new Tickets(mClient);		NotificationsManager.handleNotifications(this, "879711313152", PushHandler.class);		gcm = GoogleCloudMessaging.getInstance(this);		hub = new NotificationHub(getString(R.string.hub_name), getString(R.string.connection_string), this);		registerWithNotificationHubs();		mLocationManager = (LocationManager) getSystemService(Context.LOCATION_SERVICE);		mCriteria = new Criteria();		mCriteria.setAccuracy(Criteria.ACCURACY_COARSE); // �ｽ瘰ｸ�ｽx		mCriteria.setPowerRequirement(Criteria.POWER_LOW); // �ｽ�ｽ�ｽ�ｽ�ｽd�ｽ�ｽ		mPositions = new Positions(mClient);		mPositions.read(new TableQueryCallback<Position>(){			@Override			public void onCompleted(List<Position> positions, int count,					Exception exception, ServiceFilterResponse response) {				if(positions.isEmpty()){					mPosition = new Position();				} else {					mPosition = positions.get(0);				}			}} );	}	public void sendMessage(String message){		Message msg = new Message();		msg.setText(message);		latitude = mPosition.getLatitude();		longitude = mPosition.getLogitude();		msg.setLatitude(latitude);		msg.setLongitude(longitude);		msg.setSatelliteId(bundle.getString("satelliteId"));		msg.setTicketId(bundle.getString("ticketId"));		msg.setAnonymous(false);		Messages msgs = new Messages(mClient);		msgs.add(msg,new TableOperationCallback<Message>(){			@Override			public void onCompleted(Message arg0, Exception arg1,					ServiceFilterResponse arg2) {				// TODO 自動生成されたメソッド・スタブ				Toast.makeText(getApplicationContext(), arg0.getText(), Toast.LENGTH_LONG).show();				finish();			}		});	}}